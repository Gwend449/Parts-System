# üîß –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´: "–ó–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ—Ç" –ø—Ä–∏ /amocrm/install

## üìã –ü—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏

### 1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `sessions`** ‚ö†Ô∏è
- –ë—ã–ª–æ 2 –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ–π
- –≠—Ç–æ –ª–æ–º–∞–ª–æ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ HTTPS

**–†–ï–®–ï–ù–ò–ï**: –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –º–∏–≥—Ä–∞—Ü–∏—è

### 2. **–•—Ä–∞–Ω–µ–Ω–∏–µ state –≤ —Å–µ—Å—Å–∏–∏ –≤–º–µ—Å—Ç–æ –ë–î** üö´
- –ü—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ –Ω–∞ AmoCRM –∏ –æ–±—Ä–∞—Ç–Ω–æ —Å–µ—Å—Å–∏—è **—Ç–µ—Ä—è–µ—Ç—Å—è**
- –û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ HTTPS –∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –º–µ–∂–¥—É –¥–æ–º–µ–Ω–∞–º–∏

**–†–ï–®–ï–ù–ò–ï**: State —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î —Ç–∞–±–ª–∏—Ü–µ `amocrm_oauth_states`

### 3. **SESSION_SAME_SITE=None —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–π –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏** üîí
- –¢—Ä–µ–±—É–µ—Ç `SESSION_SECURE_COOKIE=true` (HTTPS)
- –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞—Ö

---

## ‚úÖ –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
php artisan migrate
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É `amocrm_oauth_states` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è state –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env —Ñ–∞–π–ª

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
# AmoCRM OAuth
AMOCRM_CLIENT_ID=f1457407-e1a5-4694-b976-3bc088294be4
AMOCRM_CLIENT_SECRET=AVlSbzrtacTHv62djQC8AubIqVa4bXKiOafaXlEcRfx7YeNAPgRatdJgANeYID38
AMOCRM_REDIRECT_URI=https://avrb1749.ru/amocrm/callback
AMOCRM_SUBDOMAIN=fastis02

# Session settings
SESSION_DRIVER=database
SESSION_LIFETIME=120
SESSION_DOMAIN=avrb1749.ru
SESSION_SECURE_COOKIE=true
SESSION_SAME_SITE=None
```

### –®–∞–≥ 3: –û—á–∏—Å—Ç–∏—Ç—å –ë–î —Å–µ—Å—Å–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –Ω–∞ –ø—Ä–æ–¥–µ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ –≤ –ë–î:

```bash
# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏
php artisan db:table sessions --delete-all

# –ò–ª–∏ —á–µ—Ä–µ–∑ Tinker
php artisan tinker
> DB::table('sessions')->truncate()
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –õ–æ–∫–∞–ª—å–Ω–æ (—Å HTTP):

```bash
php artisan serve
# –∏–ª–∏ ngrok http 8000

# –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ http://localhost:8000/amocrm/install
```

### –ù–∞ –ø—Ä–æ–¥–µ (—Å HTTPS):

1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ `https://avrb1749.ru/amocrm/install`
2. –í–∞—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ AmoCRM –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–µ—Ä–Ω–µ—Ç—Å—è –Ω–∞ callback
4. –í –ë–î –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è —Ç–æ–∫–µ–Ω

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:

```bash
php artisan amo:status
```

–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
```
‚úÖ AmoCRM –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!
Domain: fastis02
Access Token: abc123...
Expires At: 2026-02-18 10:51:20
Is Expired: –ù–ï–¢ ‚úÖ
```

---

## üîç –û–¢–õ–ê–î–ö–ê

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:

```bash
tail -f storage/logs/laravel.log | grep -i amocrm
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –ë–î:

```bash
php artisan tinker

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å saved states
\App\Models\AmocrmOauthState::all()

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–∫–µ–Ω—ã
\App\Models\AmocrmToken::all()

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ—Å—Å–∏–∏
DB::table('sessions')->count()
```

### –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ states:

```bash
php artisan amo:cleanup
```

---

## üìù –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `database/migrations/2026_01_18_000000_create_amocrm_oauth_states_table.php` - —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è state
- `app/Models/AmocrmOauthState.php` - Model –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å states
- `app/Console/Commands/CleanupAmocrm.php` - command –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö states

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `app/Http/Controllers/AmoAuthController.php` - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ë–î –≤–º–µ—Å—Ç–æ —Å–µ—Å—Å–∏–∏
- –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –º–∏–≥—Ä–∞—Ü–∏—è `database/migrations/2025_01_15_000000_create_sessions_table.php`

---

## üö® –ï–°–õ–ò –í–°–ï –ï–©–ï –ù–ï –†–ê–ë–û–¢–ê–ï–¢

### –ü—Ä–æ–±–ª–µ–º–∞: "–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. HTTPS ‚Üí HTTP redirect (—Å–º–µ—à–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç)
2. –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (state –∏—Å—Ç–µ–∫–∞–µ—Ç –∑–∞ 15 –º–∏–Ω—É—Ç)
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ CLIENT_ID / CLIENT_SECRET –≤ AmoCRM

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞
date

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ—á–Ω—ã–π error –≤ –ª–æ–≥–∞—Ö
php artisan tail

# –°–±—Ä–æ—Å–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ AmoCRM
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–ó–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ—Ç" –≤—Å–µ –µ—â–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è

1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω—ã: `php artisan migrate --force`
2. –û—á–∏—Å—Ç–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: `php artisan amo:cleanup`
3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: `php artisan cache:clear`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f storage/logs/laravel.log`

---

## üìû –ö–û–ù–¢–ê–ö–¢–´ –ò –†–ï–°–£–†–°–´

- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è AmoCRM OAuth](https://github.com/amocrm/amocrm-oauth-client)
- [Laravel Session Documentation](https://laravel.com/docs/sessions)
- [AmoCRM API Docs](https://www.amocrm.ru/developers/content/api)

