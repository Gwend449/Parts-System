# 🔄 Диаграмма процесса AmoCRM интеграции

## 📊 Процесс авторизации

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ПРОЦЕСС АВТОРИЗАЦИИ                              │
└─────────────────────────────────────────────────────────────────────────┘

1️⃣ ПОЛЬЗОВАТЕЛЬ ИНИЦИИРУЕТ АВТОРИЗАЦИЮ
   └─ Переходит на: https://yourdomain.com/amocrm/install
   
2️⃣ ПРИЛОЖЕНИЕ ПЕРЕНАПРАВЛЯЕТ НА AmoCRM
   └─ AmoAuthController@install генерирует ссылку
   └─ URL: https://example.amocrm.ru/oauth?client_id=...&redirect_uri=...
   
3️⃣ ПОЛЬЗОВАТЕЛЬ АВТОРИЗУЕТСЯ НА AMOCRM
   └─ Вводит логин и пароль
   └─ Нажимает "Авторизовать"
   
4️⃣ AmoCRM ПЕРЕНАПРАВЛЯЕТ ОБРАТНО
   └─ URL: https://yourdomain.com/amocrm/callback?code=...&state=...
   
5️⃣ ПРИЛОЖЕНИЕ ОБМЕНИВАЕТ КОД НА ТОКЕН
   └─ AmoAuthController@callback получает код
   └─ Отправляет код в AmoCRM
   └─ Получает access_token, refresh_token и expires_at
   
6️⃣ ТОКЕН СОХРАНЯЕТСЯ В БД
   └─ Таблица: amocrm_tokens
   └─ Содержит: domain, access_token, refresh_token, expires_at, raw
   
7️⃣ ПОЛЬЗОВАТЕЛЬ ПЕРЕНАПРАВЛЯЕТСЯ НА ГЛАВНУЮ
   └─ С сообщением об успехе: "amoCRM успешно подключена!"
   
✅ ГОТОВО! Приложение теперь может использовать AmoCRM API
```

## 🔁 Процесс использования API

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ИСПОЛЬЗОВАНИЕ AmoCRM API                             │
└─────────────────────────────────────────────────────────────────────────┘

КОНТРОЛЛЕР / СЕРВИС
      │
      ├─► new AmoService()
      │
      └─► AmoService.__construct()
              │
              ├─► Создает AmoCRMApiClient
              │
              └─► initClient()
                    │
                    ├─► Получает токен из БД
                    │
                    ├─► Проверяет не истек ли токен
                    │   └─ Если истек → refreshToken()
                    │
                    └─► Устанавливает токен и домен в клиент
      
      ГОТОВ К ИСПОЛЬЗОВАНИЮ
      │
      └─► $amo->api()->leads()->addOne($lead)
                │
                ├─► Отправляет запрос в AmoCRM API
                │
                └─► Получает ответ с ID новой сделки
```

## 📅 Жизненный цикл токена

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    ЖИЗНЕННЫЙ ЦИКЛ ТОКЕНА (30 ДНЕЙ)                      │
└──────────────────────────────────────────────────────────────────────────┘

ДЕНЬ 0 (АВТОРИЗАЦИЯ)
│
├─ Получаем: access_token, refresh_token, expires_at
├─ Сохраняем в БД
└─ ✅ Все работает

ДНИ 1-29 (ИСПОЛЬЗОВАНИЕ)
│
├─ При каждом вызове AmoService проверяем:
│  └─ Если expires_at еще в будущем → используем текущий токен
└─ ✅ Все работает

ДЕНЬ 30 (ИСТЕЧЕНИЕ)
│
├─ Проверяем: expires_at < now()
├─ Вызываем: refreshToken()
│  └─ Используем refresh_token для получения нового access_token
├─ Обновляем в БД новый access_token и expires_at
└─ ✅ Все работает дальше (еще 30 дней)

И ТАК БЕСКОНЕЧНО...
└─ Пока не отозван доступ вручную в AmoCRM
```

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         АРХИТЕКТУРА ИНТЕГРАЦИИ                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│   КОНТРОЛЛЕР    │
│  AmoAuthController
│  AmoTestController
└────────┬────────┘
         │
         ├─► Зависимость: AmoService
         │
         └─► Возвращает: JSON или Redirect
         
┌────────┴────────────────────────────────────────────┐
│                    СЕРВИС AmoCRM                     │
│                   AmoService                         │
│                                                      │
│  ┌──────────────────────────────────────────────┐   │
│  │ __construct()                                │   │
│  │ - Создает AmoCRMApiClient                    │   │
│  │ - Инициализирует клиент через initClient()  │   │
│  └──────────────────────────────────────────────┘   │
│                                                      │
│  ┌──────────────────────────────────────────────┐   │
│  │ initClient()                                 │   │
│  │ - Получает токен из БД                       │   │
│  │ - Проверяет expiration                       │   │
│  │ - Если истек → вызывает refreshToken()       │   │
│  │ - Устанавливает токен в клиент              │   │
│  └──────────────────────────────────────────────┘   │
│                                                      │
│  ┌──────────────────────────────────────────────┐   │
│  │ refreshToken()                               │   │
│  │ - Использует refresh_token                   │   │
│  │ - Получает новый access_token                │   │
│  │ - Обновляет в БД                            │   │
│  └──────────────────────────────────────────────┘   │
│                                                      │
│  ┌──────────────────────────────────────────────┐   │
│  │ api()                                        │   │
│  │ - Возвращает готовый AmoCRMApiClient         │   │
│  │ - Готов к использованию                      │   │
│  └──────────────────────────────────────────────┘   │
└────────┬───────────────────────────────────────────┘
         │
         ├─► Использует: AmocrmToken (Model)
         │
         └─► Работает с: AmoCRM API
         
┌────────┴──────────────────────────────────────────┐
│              DATABASE (MySQL/PostgreSQL)          │
│                                                   │
│    Таблица: amocrm_tokens                        │
│    ┌──────────────────────────────────────┐      │
│    │ id                                   │      │
│    │ domain (example.amocrm.ru)           │      │
│    │ access_token                         │      │
│    │ refresh_token                        │      │
│    │ expires_at                           │      │
│    │ raw (полный JSON ответ)              │      │
│    │ created_at, updated_at               │      │
│    └──────────────────────────────────────┘      │
└───────────────────────────────────────────────────┘
```

## 🔐 Поток данных

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ПОТОК ДАННЫХ CREDENTIALS                        │
└─────────────────────────────────────────────────────────────────────────┘

AmoCRM Dashboard
    │
    └─► Client ID: abc123def456
    └─► Client Secret: xyz789uvw012
    └─► Redirect URI: https://yourdomain.com/amocrm/callback
    └─► Subdomain: example
         │
         ├─► В .env файле (локально)
         │   └─ AMO_CLIENT_ID=abc123def456
         │   └─ AMO_CLIENT_SECRET=xyz789uvw012
         │   └─ AMO_REDIRECT_URI=https://yourdomain.com/amocrm/callback
         │   └─ AMOCRM_SUBDOMAIN=example
         │
         ├─► В config/amocrm.php (читает из .env)
         │   └─ config('amocrm.client_id')
         │   └─ config('amocrm.client_secret')
         │   └─ config('amocrm.redirect_uri')
         │   └─ config('amocrm.subdomain')
         │
         └─► В AmoService (использует конфиг)
             │
             ├─► При авторизации отправляет Client ID и Secret в AmoCRM
             │
             └─► При callback получает токены и сохраняет в БД
```

## 🎯 Типовой сценарий использования

```
┌─────────────────────────────────────────────────────────────────────────┐
│              СЦЕНАРИЙ: Создание заказа с отправкой в AmoCRM            │
└─────────────────────────────────────────────────────────────────────────┘

ПОЛЬЗОВАТЕЛЬ ПОЛ­НЯБЕТ ФОРМУ ЗАКАЗА
    │
    ▼
POST /orders (OrderController@store)
    │
    ├─► Валидация данных
    │
    ├─► Сохранение заказа в БД
    │
    ├─► Внедрение AmoService через DI
    │   └─ public function store(AmoService $amo)
    │
    ├─► Создание контакта в AmoCRM
    │   └─ $contact = new ContactModel()
    │   └─ $amo->api()->contacts()->addOne($contact)
    │
    ├─► Создание сделки в AmoCRM
    │   └─ $lead = new LeadModel()
    │   └─ $amo->api()->leads()->addOne($lead)
    │
    ├─► Добавление примечания
    │   └─ $note = new NoteModel()
    │   └─ $amo->api()->notes($leadId)->addOne($note)
    │
    ▼
УСПЕШНО! Заказ в БД приложения И в AmoCRM
```

---

**Все процессы автоматизированы и готовы к использованию!** ✅
