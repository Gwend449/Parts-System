# 🔄 ДИАГРАММА ПОТОКА ДАННЫХ: Формы → AmoCRM

## 📊 Полный поток при отправке формы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ В БРАУЗЕРЕ                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌──────────────────────────────┐
                    │   Заполняет форму:            │
                    │   - Имя: Иван                │
                    │   - Email: ivan@mail.com     │
                    │   - Телефон: +7-910-xxx-xx   │
                    │   - Марка: BMW               │
                    └──────────────────────────────┘
                                    │
                                    ▼
                    ┌──────────────────────────────┐
                    │   Нажимает:                   │
                    │   "Отправить запрос"         │
                    └──────────────────────────────┘
                                    │
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │ ФРОНТЕНД ВАЛИДАЦИЯ (JavaScript)                  │
        ├───────────────────────────────────────────────────┤
        │ 1. Проверить Имя (не пусто)                      │
        │ 2. Проверить Email (формат + синтаксис)         │
        │ 3. Проверить Телефон (не пусто)                 │
        │ 4. Проверить CSRF токен                          │
        └───────────────────────────────────────────────────┘
                                    │
                         (Ошибки? ← → Успешно?)
                                    │
                         ┌──────────┴──────────┐
                         │                     │
                    Ошибка               Успешно
                         │                     │
                         ▼                     ▼
                ┌────────────────┐    ┌─────────────────────────┐
                │ Красный алерт: │    │ Показать спиннер        │
                │ "Исправьте     │    │ "Отправка..."           │
                │  ошибки"       │    │                         │
                └────────────────┘    │ Собрать данные:         │
                                      │ {                       │
                                      │   name, email,          │
                                      │   phone, brand,         │
                                      │   message,              │
                                      │   csrf_token            │
                                      │ }                       │
                                      └─────────────────────────┘
                                             │
                                             ▼
                           ┌─────────────────────────────────┐
                           │ ОТПРАВИТЬ POST ЗАПРОС:          │
                           │ POST /api/catalog-form          │
                           │ Content-Type: application/json  │
                           └─────────────────────────────────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            LARAVEL СЕРВЕР                               │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌──────────────────────────────┐
                    │ ContactFormRequest::validate │
                    │ (Валидация бэкенда)          │
                    │                              │
                    │ Rules:                       │
                    │ - name: required|string      │
                    │ - email: required|email:rfc  │
                    │ - phone: required|regex      │
                    │ - brand: nullable            │
                    │ - message: nullable          │
                    └──────────────────────────────┘
                                    │
                         (Ошибки? ← → Успешно?)
                                    │
                         ┌──────────┴──────────┐
                         │                     │
                    Ошибка               Успешно
                         │                     │
                         ▼                     ▼
                ┌────────────────┐    ┌──────────────────────────┐
                │ HTTP 422       │    │ FormSubmissionController │
                │ Вернуть ошибки │    │ submitCatalogForm()      │
                │ JSON           │    └──────────────────────────┘
                └────────────────┘                  │
                         ▲                          ▼
                         │           ┌─────────────────────────────┐
                         │           │ AmoService::sendLead()      │
                         │           │                             │
                         │           │ Параметры:                  │
                         │           │ - name: "Иван"              │
                         │           │ - phone: "+7-910-xxx-xx"    │
                         │           │ - email: "ivan@mail.com"    │
                         │           │ - brand: "BMW"              │
                         │           │ - source: "Каталог"         │
                         │           └─────────────────────────────┘
                         │                          │
                         │                          ▼
                         │           ┌─────────────────────────────┐
                         │           │ createOrUpdateContact()     │
                         │           │                             │
                         │           │ Создать ContractModel:      │
                         │           │ 1. setFirstName("Иван")     │
                         │           │ 2. setCustomFields([        │
                         │           │      'PHONE': ...,          │
                         │           │      'EMAIL': ...           │
                         │           │    ])                       │
                         │           │ 3. api()->contacts()->add() │
                         │           │ 4. Return contactId         │
                         │           └─────────────────────────────┘
                         │                          │
                         │                          ▼
                         │           ┌─────────────────────────────┐
                         │           │ api().leads().addOne()      │
                         │           │                             │
                         │           │ Создать LeadModel:          │
                         │           │ - setName("Иван (BMW)")     │
                         │           │ - setContactsId(contactId)  │
                         │           │ - Return leadId             │
                         │           └─────────────────────────────┘
                         │                          │
                         │                          ▼
                         │           ┌─────────────────────────────┐
                         │           │ Log::info(...)              │
                         │           │ Записать в логи:            │
                         │           │ - lead_id: 12345            │
                         │           │ - name, email, phone        │
                         │           │ - source: "Каталог"         │
                         │           └─────────────────────────────┘
                         │                          │
                         │                          ▼
                         │           ┌─────────────────────────────┐
                         │           │ HTTP 201 Created            │
                         │           │                             │
                         │           │ Response JSON:              │
                         │           │ {                           │
                         │           │   "status": "success",      │
                         │           │   "message": "Спасибо!...", │
                         │           │   "lead_id": 12345          │
                         │           │ }                           │
                         │           └─────────────────────────────┘
                         └───────────────────────────────────────────┐
                                                                     │
                                                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      АМОCRM (Внешний сервис)                            │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌──────────────────────────────┐
                    │ AmoCRM API получила данные:  │
                    │                              │
                    │ Контакт (Contact):           │
                    │ - Имя: Иван                  │
                    │ - Email: ivan@mail.com       │
                    │ - Телефон: +7-910-xxx-xx     │
                    │ - ID: 999888                  │
                    │                              │
                    │ Лид (Lead):                  │
                    │ - Имя: Иван (BMW)            │
                    │ - Контакт: 999888            │
                    │ - Источник: Каталог          │
                    │ - Статус: Новый              │
                    │ - ID: 12345                  │
                    └──────────────────────────────┘
                                    │
                                    ▼
                        ✅ Лид создан в AmoCRM
                        ✅ Контакт сохранён
                        ✅ Email доступен
                        ✅ Источник указан
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      ОБРАТНО В БРАУЗЕР                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌──────────────────────────────┐
                    │ JavaScript получил ответ:   │
                    │ HTTP 201                     │
                    │ {status: "success", ...}     │
                    └──────────────────────────────┘
                                    │
                                    ▼
                    ┌──────────────────────────────┐
                    │ Убрать спиннер               │
                    │ Показать зелёный алерт:      │
                    │ "Спасибо! Ваш запрос        │
                    │  отправлен. Мы свяжемся     │
                    │  с вами в течение дня."     │
                    └──────────────────────────────┘
                                    │
                                    ▼
                    ┌──────────────────────────────┐
                    │ Очистить форму:              │
                    │ - name = ""                  │
                    │ - email = ""                 │
                    │ - phone = ""                 │
                    │ - brand = ""                 │
                    │ - message = ""               │
                    └──────────────────────────────┘
                                    │
                                    ▼
                        ✅ ГОТОВО!
                        ✅ Форма в исходном состоянии
                        ✅ Можно отправить ещё
```

---

## 🔴 ПОТОК ПРИ ОШИБКЕ

```
┌─────────────────────────────────────────────────────┐
│ Пользователь заполняет форму неправильно:           │
│ Email: "notanemail" (без @)                         │
└─────────────────────────────────────────────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │ Фронтенд валидация НЕ ловит  │
        │ (регулярные выражения не     │
        │  полная RFC валидация)       │
        └──────────────────────────────┘
                       │
                       ▼
              (Отправить запрос)
                       │
                       ▼
        ┌──────────────────────────────┐
        │ Laravel валидация ЛОВИТ       │
        │ 'email' => 'required|email'   │
        └──────────────────────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │ HTTP 422 Unprocessable       │
        │                              │
        │ {                            │
        │   "errors": {                │
        │     "email": [               │
        │       "Пожалуйста, введите   │
        │        корректный адрес      │
        │        почты"                │
        │     ]                        │
        │   }                          │
        │ }                            │
        └──────────────────────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │ JavaScript обрабатывает      │
        │ ошибку                       │
        │                              │
        │ 1. Убрать спиннер            │
        │ 2. Показать красный алерт    │
        │ 3. Подсветить ошибки красным│
        │ 4. НЕ очищать форму         │
        └──────────────────────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │ Красный алерт:               │
        │ "Пожалуйста, исправьте      │
        │  ошибки в форме"             │
        │                              │
        │ [Email] ← "Пожалуйста,      │
        │           введите            │
        │           корректный адрес"  │
        └──────────────────────────────┘
                       │
                       ▼
        Пользователь исправляет и
        отправляет снова ✅
```

---

## 📦 КОМПОНЕНТЫ СИСТЕМЫ

```
┌──────────────────────────────────────────────────────┐
│ 1. ФРОНТЕНД (HTML + JavaScript)                      │
├──────────────────────────────────────────────────────┤
│ - resources/views/livewire/pages/catalog.blade.php   │
│ - resources/views/livewire/pages/contacts.blade.php  │
│ - resources/views/livewire/engine-cost-modal.blade.php│
│                                                       │
│ Функции:                                             │
│ • Собрать данные из формы                           │
│ • Валидировать на клиенте                           │
│ • Отправить POST запрос                             │
│ • Показать результат (алерт)                        │
└──────────────────────────────────────────────────────┘
                       ↓ HTTP POST
┌──────────────────────────────────────────────────────┐
│ 2. ВАЛИДАЦИЯ (Laravel Request)                      │
├──────────────────────────────────────────────────────┤
│ - app/Http/Requests/ContactFormRequest.php           │
│                                                       │
│ Проверяет:                                          │
│ • name: required, string, 2-255 символов           │
│ • email: required, valid email format               │
│ • phone: required, regex pattern                    │
│ • brand, message: nullable                          │
└──────────────────────────────────────────────────────┘
                       ↓ Валидные данные
┌──────────────────────────────────────────────────────┐
│ 3. КОНТРОЛЛЕР (Laravel Controller)                   │
├──────────────────────────────────────────────────────┤
│ - app/Http/Controllers/FormSubmissionController.php  │
│                                                       │
│ Методы:                                              │
│ • submitContactForm()  → лиды из /contacts          │
│ • submitCatalogForm()  → лиды из /catalog           │
│                                                       │
│ Действия:                                            │
│ 1. Получить валидированные данные                   │
│ 2. Вызвать AmoService->sendLead()                   │
│ 3. Залогировать операцию                            │
│ 4. Вернуть JSON ответ                               │
└──────────────────────────────────────────────────────┘
                       ↓ sendLead()
┌──────────────────────────────────────────────────────┐
│ 4. СЕРВИС AMOCRM (Laravel Service)                  │
├──────────────────────────────────────────────────────┤
│ - app/Services/AmoService.php                        │
│                                                       │
│ Методы:                                              │
│ • sendLead(name, phone, email, ...) → lead_id       │
│ • createOrUpdateContact(name, phone, email)         │
│ • addNoteToLead(leadId, text)                       │
│                                                       │
│ Действия:                                            │
│ 1. Создать контакт в AmoCRM                         │
│ 2. Добавить email в контакт                         │
│ 3. Создать лид и связать с контактом                │
│ 4. Добавить примечание (опционально)                │
│ 5. Вернуть lead_id                                  │
└──────────────────────────────────────────────────────┘
                       ↓ AmoCRM API
┌──────────────────────────────────────────────────────┐
│ 5. AMOCRM (Внешний сервис)                          │
├──────────────────────────────────────────────────────┤
│ • Создан контакт с email                            │
│ • Создан лид с источником                           │
│ • Связь контакт ↔ лид установлена                   │
│ • Данные доступны в AmoCRM UI                       │
└──────────────────────────────────────────────────────┘
                       ↓ Ответ
┌──────────────────────────────────────────────────────┐
│ 6. ЛОГИРОВАНИЕ (Laravel Logs)                       │
├──────────────────────────────────────────────────────┤
│ - storage/logs/laravel.log                           │
│                                                       │
│ Записывается:                                        │
│ • Успешная отправка (lead_id, название источника)  │
│ • Ошибки с полным trace                             │
│ • Попытки валидации (какие ошибки были)             │
│ • Проблемы с API                                    │
└──────────────────────────────────────────────────────┘
```

---

## ✨ ТОЧКИ ИНТЕГРАЦИИ

```
Браузер пользователя
  └─ JavaScript обработчик submit
  └─ POST /api/catalog-form
     └─ FormSubmissionController::submitCatalogForm()
        └─ ContactFormRequest::validate()
        └─ AmoService::sendLead()
           └─ createOrUpdateContact() → создать контакт
              └─ api()->contacts()->addOne()
              └─ return contactId
           └─ api()->leads()->addOne() → создать лид
           └─ addNoteToLead() → добавить примечание
           └─ return leadId
        └─ Log::info() → залогировать
        └─ return JSON response
  └─ JavaScript показывает алерт
  └─ Форма очищается
```

---

Диаграмма готова! Теперь всё ясно видно.
