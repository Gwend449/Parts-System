# üéØ –ò–¢–û–ì–û–í–û–ï –†–ï–®–ï–ù–ò–ï: –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É "/amocrm/install"

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢ (3 –ú–ò–ù–£–¢–´)

### 1Ô∏è‚É£ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
php artisan migrate --force
```

**–ß—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `amocrm_oauth_states` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- State –±–æ–ª—å—à–µ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ –º–µ–∂–¥—É –¥–æ–º–µ–Ω–∞–º–∏

### 2Ô∏è‚É£ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à

```bash
php artisan cache:clear
php artisan config:cache
```

### 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

```bash
php artisan amo:status
```

---

## üî¥ –ß–¢–û –ë–´–õ–û –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `sessions` ‚ö†Ô∏è
**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ "SQLSTATE[42S01]: Table 'sessions' already exists"
- –°–µ—Å—Å–∏–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –î–≤–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É
- `0001_01_01_000000_create_users_table.php` 
- `2025_01_15_000000_create_sessions_table.php` ‚ùå –£–î–ê–õ–ï–ù–ê

### –ü—Ä–æ–±–ª–µ–º–∞ #2: State —Ö—Ä–∞–Ω–∏–ª—Å—è –≤ —Å–µ—Å—Å–∏–∏ üö´
**–°–∏–º–ø—Ç–æ–º—ã:**
- "–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
- State –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:**
```
–ë—ã–ª–æ:
1. –°–æ—Ö—Ä–∞–Ω—è–µ–º state –≤ $_SESSION['amocrm_oauth_state']
2. –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ AmoCRM (–¥—Ä—É–≥–æ–π –¥–æ–º–µ–Ω)
3. AmoCRM —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ callback
4. –°–µ—Å—Å–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞! ‚ùå
```

**–†–µ—à–µ–Ω–∏–µ:**
```
–¢–µ–ø–µ—Ä—å:
1. –°–æ—Ö—Ä–∞–Ω—è–µ–º state –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ amocrm_oauth_states)
2. –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ AmoCRM
3. –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ callback
4. –ü—Ä–æ–≤–µ—Ä—è–µ–º state –≤ –ë–î ‚úÖ
```

### –ü—Ä–æ–±–ª–µ–º–∞ #3: HTTPS + SESSION_SAME_SITE=None üîí
**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–µ—Å—Å–∏—è –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ HTTPS
- Cookie –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –º–µ–∂–¥—É –¥–æ–º–µ–Ω–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:** State —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î, –Ω–µ –≤ cookie!

---

## ‚úÖ –ß–¢–û –¢–´ –ü–û–õ–£–ß–ò–®–¨

### –î–æ:
```
‚ùå –û—à–∏–±–∫–∞ "–ó–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ—Ç" –ø—Ä–∏ /amocrm/install
‚ùå "–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
‚ùå State –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ
```

### –ü–æ—Å–ª–µ:
```
‚úÖ /amocrm/install –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ AmoCRM –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚úÖ Callback —É—Å–ø–µ—à–Ω–æ –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç –∫–æ–¥ –Ω–∞ —Ç–æ–∫–µ–Ω
‚úÖ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
‚úÖ –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
```

---

## üß™ –ü–û–õ–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –®–∞–≥ 1: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (HTTP)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
php artisan serve

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å ngrok (–µ—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å callback)
ngrok http 8000

# –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ http://localhost:8000/amocrm/install
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
1. –û—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ AmoCRM
2. –í–≤–µ–¥–∏ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ AmoCRM
3. –í–µ—Ä–Ω–µ—Ç—Å—è –Ω–∞ —Ç–≤–æ–π —Å–∞–π—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "amoCRM —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!"

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –ë–î

```bash
php artisan tinker

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
\App\Models\AmocrmToken::all()

# –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Ö–æ–∂ –Ω–∞:
# {
#   "id": 1,
#   "domain": "fastis02",
#   "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
#   "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
#   "expires_at": "2026-02-18 10:51:20",
#   "created_at": "2026-01-18 10:51:20",
#   "updated_at": "2026-01-18 10:51:20"
# }
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

```bash
php artisan amo:status
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ AmoCRM –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–∞—Ä–∞–º–µ—Ç—Ä             ‚îÇ –ó–Ω–∞—á–µ–Ω–∏–µ                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Domain               ‚îÇ fastis02                             ‚îÇ
‚îÇ Access Token         ‚îÇ eyJ0eXAiOiJKV1QiLCJhbGciOiJ...       ‚îÇ
‚îÇ Expires At           ‚îÇ 2026-02-18 10:51:20                  ‚îÇ
‚îÇ Is Expired           ‚îÇ –ù–ï–¢ ‚úÖ                               ‚îÇ
‚îÇ Created At           ‚îÇ 2026-01-18 10:51:20                  ‚îÇ
‚îÇ Updated At           ‚îÇ 2026-01-18 10:51:20                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –®–∞–≥ 4: –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (HTTPS)

1. –£–±–µ–¥–∏—Å—å —á—Ç–æ –≤ `.env` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:
   ```env
   APP_ENV=production
   AMOCRM_REDIRECT_URI=https://avrb1749.ru/amocrm/callback
   SESSION_SECURE_COOKIE=true
   ```

2. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ `https://avrb1749.ru/amocrm/install`

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   ```bash
   docker compose logs -f app | grep -i amocrm
   # –∏–ª–∏
   tail -f storage/logs/laravel.log | grep -i amocrm
   ```

---

## üìã –§–ê–ô–õ–´ –ö–û–¢–û–†–´–ï –ë–´–õ–ò –ò–ó–ú–ï–ù–ï–ù–´

### ‚ú® –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
1. **`database/migrations/2026_01_18_000000_create_amocrm_oauth_states_table.php`**
   - –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è state –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö states

2. **`app/Models/AmocrmOauthState.php`**
   - –ú–µ—Ç–æ–¥—ã: `generateState()`, `verifyAndDelete()`, `cleanup()`
   - State –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 15 –º–∏–Ω—É—Ç

3. **`app/Console/Commands/CleanupAmocrm.php`**
   - –ö–æ–º–∞–Ω–¥–∞: `php artisan amo:cleanup`
   - –£–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ states

### üîß –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. **`app/Http/Controllers/AmoAuthController.php`**
   - –ú–µ—Ç–æ–¥—ã `install()` –∏ `callback()` –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω—ã
   - State —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î –≤–º–µ—Å—Ç–æ —Å–µ—Å—Å–∏–∏
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### üóëÔ∏è –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. **`database/migrations/2025_01_15_000000_create_sessions_table.php`**
   - –î—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –º–∏–≥—Ä–∞—Ü–∏—è (–±—ã–ª–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –æ—Å–Ω–æ–≤–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π)

---

## üîç –û–¢–õ–ê–î–ö–ê

### –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

#### 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```bash
php artisan tinker
> config('amocrm')
```

**–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:**
```
{
  "client_id": "f1457407-e1a5-4694-b976-3bc088294be4",
  "client_secret": "AVlSbzrtacTHv62djQC8AubIqVa4bXKiOafaXlEcRfx7YeNAPgRatdJgANeYID38",
  "redirect_uri": "https://avrb1749.ru/amocrm/callback",
  "subdomain": "fastis02",
  "private_token": null
}
```

#### 2Ô∏è‚É£ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
```bash
# –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± AmoCRM:
tail -n 100 storage/logs/laravel.log | grep -i amocrm

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫:
tail -f storage/logs/laravel.log | grep 'AmoCRM'

# Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
docker compose exec app tail -f storage/logs/laravel.log
```

#### 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
```bash
php artisan tinker

# –¢–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
> DB::table('amocrm_oauth_states')->count()

# –¢–∞–±–ª–∏—Ü–∞ —Å–µ—Å—Å–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
> DB::table('sessions')->count()

# –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å?
> \App\Models\AmocrmToken::count()
```

#### 4Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ
```bash
php artisan migrate:refresh --seed
php artisan cache:clear
php artisan config:cache
php artisan view:clear
```

#### 5Ô∏è‚É£ Docker (–µ—Å–ª–∏ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
```bash
docker compose down
docker compose up -d

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker compose exec app php artisan migrate --force

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker compose exec app php artisan amo:status
```

---

## üí° –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|---------|
| "–ó–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ—Ç" –ø—Ä–∏ /amocrm/install | –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ | –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏, –ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥ |
| "–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" | State –∏—Å—Ç–µ–∫ (15 –º–∏–Ω—É—Ç) –∏–ª–∏ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è | –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞, state –≤ –ë–î |
| "HTTP 400" –ø—Ä–∏ –æ–±–º–µ–Ω–µ –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π CLIENT_ID/SECRET | –ü—Ä–æ–≤–µ—Ä—å –≤ AmoCRM Dashboard |
| "HTTPS only cookies" –æ—à–∏–±–∫–∞ | SESSION_SECURE_COOKIE=false –ø—Ä–∏ HTTPS | –£—Å—Ç–∞–Ω–æ–≤–∏ SESSION_SECURE_COOKIE=true |
| –ë–î –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –°—Ç–∞—Ä–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç | –í—ã–ø–æ–ª–Ω–∏ `php artisan migrate:refresh` |

---

## üìû –ü–û–°–õ–ï–î–£–Æ–©–ò–ï –î–ï–ô–°–¢–í–ò–Ø

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API:**
   ```php
   use App\Services\AmoService;
   
   $amo = new AmoService();
   $leads = $amo->api()->leads()->list();
   ```

2. **–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é:**
   ```bash
   php artisan tinker
   > \App\Models\AmocrmToken::first()->update(['expires_at' => now()->addDays(1)])
   ```

3. **–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ states:**
   ```bash
   php artisan amo:cleanup
   ```

4. **–ü–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
   - –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ `/amocrm/install` —Å–Ω–æ–≤–∞
   - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤ AmoCRM
   - –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üéì –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

```
HTTP Request: GET /amocrm/install
        ‚Üì
AmoAuthController::install()
        ‚Üì
AmocrmOauthState::generateState($subdomain)
        ‚Üì
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å state –≤ –ë–î (15 –º–∏–Ω—É—Ç)
        ‚Üì
–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ AmoCRM OAuth URL
        ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å –≤ AmoCRM
        ‚Üì
AmoCRM –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ /amocrm/callback?code=...&state=...
        ‚Üì
AmoAuthController::callback()
        ‚Üì
AmocrmOauthState::verifyAndDelete($state)
        ‚Üì
–û–±–º–µ–Ω—è—Ç—å code –Ω–∞ access_token + refresh_token
        ‚Üì
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É amocrm_tokens
        ‚Üì
–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ / —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º —É—Å–ø–µ—Ö–∞
```

---

**üéâ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å —Ç–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ AmoCRM!**

–ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã - —Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏: `tail -f storage/logs/laravel.log`
