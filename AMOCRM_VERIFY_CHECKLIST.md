# ‚úÖ –ö–û–ù–¢–†–û–õ–¨: –ß—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üéØ –ì–õ–ê–í–ù–ê–Ø –û–®–ò–ë–ö–ê

–¢—ã –≤–∏–¥–∏—à—å –ª–æ–≥–∏ —á—Ç–æ `/amocrm/install` **—Ä–∞–±–æ—Ç–∞–µ—Ç**, –Ω–æ –ø–æ—Ç–æ–º –æ—à–∏–±–∫–∞ "–ó–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ—Ç".

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ `install()` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è, –Ω–æ `callback()` **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è**.

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ü–†–û–í–ï–†–ö–ò

### ‚úÖ –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redirect URI –≤ AmoCRM

```
–°—Å—ã–ª–∫–∞: https://fastis02.amocrm.ru (–¢–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç)
–ü—É—Ç—å: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º ‚Üí –ú–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí [–¢–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ]

–î–û–õ–ñ–ù–û –ë–´–¢–¨:
‚úÖ Redirect URI: https://avrb1749.ru/amocrm/callback

–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –ë–£–î–ï–¢:
‚ùå https://avrb1749.ru/amocrm/install (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å)
‚ùå http://avrb1749.ru/amocrm/callback (–±–µ–∑ https)
‚ùå https://avrb1749.ru/amocrm/callback/ (—Å–ª—ç—à –≤ –∫–æ–Ω—Ü–µ)
‚ùå https://avrb1749.ru/api/amocrm/callback (–ª–∏—à–Ω–∏–µ –ø–∞–ø–∫–∏)
```

**–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**
1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ AmoCRM
2. –ù–∞–∂–∞—Ç—å "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
3. –ò–∑–º–µ–Ω–∏—Ç—å Redirect URI
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

---

### ‚úÖ –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env —Ñ–∞–π–ª

```bash
ssh user@avrb1749.ru
cat /var/www/.env | grep AMOCRM
```

**–î–æ–ª–∂–Ω—ã –±—ã—Ç—å:**
```env
AMOCRM_CLIENT_ID=f1457407-e1a5-4694-b976-3bc088294be4
AMOCRM_CLIENT_SECRET=AVlSbzrtacTHv62djQC8AubIqVa4bXKiOafaXlEcRfx7YeNAPgRatdJgANeYID38
AMOCRM_REDIRECT_URI=https://avrb1749.ru/amocrm/callback
AMOCRM_SUBDOMAIN=fastis02
```

**–ï—Å–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
nano /var/www/.env

# –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—ç—à
php artisan config:cache
```

---

### ‚úÖ –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Route —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

```bash
php artisan route:list | grep amocrm
```

**–î–æ–ª–∂–Ω—ã –±—ã—Ç—å 3 route:**
```
GET /amocrm/install
GET /amocrm/callback  
ANY /amocrm/callback-debug
```

**–ï—Å–ª–∏ –Ω–µ –≤–∏–¥–∏—à—å:**
```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å routes
php artisan route:cache
php artisan route:clear
```

---

### ‚úÖ –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

```bash
docker exec app php artisan migrate --force

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
docker exec app php artisan tinker
> DB::table('amocrm_oauth_states')->count()
> exit
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0** (–µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ states)

---

### ‚úÖ –®–∞–≥ 5: –í—Ä—É—á–Ω—É—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å callback

```bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ route —Ä–∞–±–æ—Ç–∞–µ—Ç
curl -v https://avrb1749.ru/amocrm/callback?code=test&state=test 2>&1 | head -30
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- HTTP 200 –∏–ª–∏ 302 (—Ä–µ–¥–∏—Ä–µ–∫—Ç)
- **–ù–ï** HTTP 404 (–Ω–µ –Ω–∞–π–¥–µ–Ω)
- **–ù–ï** HTTP 403 (–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω)

---

### ‚úÖ –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ callback-debug

1. –û—Ç–∫–æ–π ssh –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. –í–∂–∏–≤—É—é —Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏:
   ```bash
   tail -f /var/www/storage/logs/laravel.log | grep -i "callback"
   ```

3. –ü–æ–ø—Ä–æ—Å–∏ —á–µ–ª–æ–≤–µ–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â–µ —Ä–∞–∑

4. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å `AmoCRM CALLBACK DEBUG` - –∑–Ω–∞—á–∏—Ç callback –ø—Ä–∏—Ö–æ–¥–∏—Ç ‚úÖ

5. –ï—Å–ª–∏ –ù–ï –≤–∏–¥–∏—à—å - –∑–Ω–∞—á–∏—Ç AmoCRM –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback ‚ùå

---

## üîç –ê–ù–ê–õ–ò–ó –õ–û–ì–û–í

### –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –ª–æ–≥ (–≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):
```
[2026-01-18 11:05:31] production.INFO: AmoCRM OAuth: –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
[2026-01-18 11:05:31] production.DEBUG: AmoCRM OAuth: state —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
[2026-01-18 11:05:31] production.INFO: AmoCRM OAuth: –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
--- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ AmoCRM ---
[2026-01-18 11:05:40] production.INFO: AmoCRM CALLBACK DEBUG {"method":"GET","all_params":{"code":"...","state":"...","referer":"fastis02"},...}
[2026-01-18 11:05:40] production.INFO: AmoCRM OAuth: callback –ø–æ–ª—É—á–µ–Ω
[2026-01-18 11:05:40] production.INFO: AmoCRM OAuth: –æ–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
[2026-01-18 11:05:41] production.INFO: AmoCRM —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞
```

### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–æ–≥ (callback –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç):
```
[2026-01-18 11:05:31] production.INFO: AmoCRM OAuth: –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é ‚úÖ
[2026-01-18 11:05:31] production.DEBUG: AmoCRM OAuth: state —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω ‚úÖ
[2026-01-18 11:05:31] production.INFO: AmoCRM OAuth: –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é ‚úÖ
--- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ AmoCRM ---
--- –ù–ò–ß–ï–ì–û –ù–ï –õ–û–ì–ò–†–£–ï–¢–°–Ø! ‚ùå ---
# –ù–µ—Ç "AmoCRM CALLBACK DEBUG"
# –ù–µ—Ç "AmoCRM OAuth: callback –ø–æ–ª—É—á–µ–Ω"
```

**–ï—Å–ª–∏ –≤–∏–¥–∏—à—å –≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –≤ AmoCRM Dashboard!**

---

## üõ†Ô∏è –ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: Redirect URI –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

```
‚ùå –ë–´–õ–û: https://avrb1749.ru/amocrm/install
‚úÖ –î–û–õ–ñ–ù–û: https://avrb1749.ru/amocrm/callback
```

**–ò—Å–ø—Ä–∞–≤–∏—Ç—å:**
1. –û—Ç–∫—Ä—ã—Ç—å AmoCRM Dashboard
2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
3. –°–º–µ–Ω–∏—Ç—å Redirect URI –Ω–∞: `https://avrb1749.ru/amocrm/callback`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

### –í–∞—Ä–∏–∞–Ω—Ç 2: .env –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω

```bash
docker exec app php artisan config:cache
docker exec app php artisan cache:clear
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞

```bash
docker exec app php artisan migrate --force
```

### –í–∞—Ä–∏–∞–Ω—Ç 4: Route –Ω–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω

```bash
docker exec app php artisan route:clear
```

---

## üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê

–ü–æ—Å–ª–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. **–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫—ç—à–∏:**
   ```bash
   php artisan config:cache
   php artisan route:cache
   php artisan cache:clear
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:**
   ```bash
   php artisan migrate --force
   ```

3. **–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é:**
   - –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://avrb1749.ru/amocrm/install
   - –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ AmoCRM
   - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω:**
   ```bash
   php artisan amo:status
   # –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω
   ```

---

## üìû –ï–°–õ–ò –í–°–ï –ï–©–ï –ù–ï –†–ê–ë–û–¢–ê–ï–¢

–°–æ–±–µ—Ä–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å:

1. **Redirect URI –∏–∑ AmoCRM:**
   ```
   (—Å–∫—Ä–∏–Ω—à–æ—Ç –∏–∑ Dashboard)
   ```

2. **.env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
   ```bash
   grep AMOCRM .env
   ```

3. **–õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫:**
   ```bash
   tail -n 50 storage/logs/laravel.log
   ```

4. **–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
   ```bash
   curl -v https://avrb1749.ru/amocrm/callback?test=1
   ```

5. **–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
   ```bash
   php artisan --version
   php -v
   ```

---

**üî¥ 99% –æ—à–∏–±–æ–∫: Redirect URI –≤ AmoCRM –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å .env!**
