# üîç –û–¢–õ–ê–î–ö–ê: Callback –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

## üéØ –ü–†–û–ë–õ–ï–ú–ê

–í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ:
- ‚úÖ `/amocrm/install` - –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω
- ‚úÖ State —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î
- ‚úÖ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ AmoCRM
- ‚ùå **`/amocrm/callback` - –ù–ò–ö–û–ì–î–ê –ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø**
- ‚ùå "–ó–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ—Ç"

---

## üîß –†–ï–®–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å AmoCRM Dashboard

### –®–∞–≥ 1: –ü–µ—Ä–µ–π—Ç–∏ –≤ AmoCRM –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

1. –õ–æ–≥–∏–Ω –≤ AmoCRM: https://fastis02.amocrm.ru
2. –ü–µ—Ä–µ–π—Ç–∏: **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** ‚Üí **–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º** ‚Üí **–ú–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
3. –ù–∞–∂–∞—Ç—å –Ω–∞ —Ç–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```
‚úÖ Client ID: f1457407-e1a5-4694-b976-3bc088294be4
‚úÖ Client Secret: AVlSbzrtacTHv62djQC8AubIqVa4bXKiOafaXlEcRfx7YeNAPgRatdJgANeYID38
‚úÖ Redirect URI: https://avrb1749.ru/amocrm/callback
‚úÖ –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –ê–∫—Ç–∏–≤–Ω–æ
```

**–ì–õ–ê–í–ù–û–ï:** Redirect URI –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–¢–û–ß–ù–û** —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ `.env`!

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑—É—è debug route

–ú—ã –¥–æ–±–∞–≤–∏–ª–∏ route `/amocrm/callback-debug`. –≠—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç.

1. –ü–æ–ø—Ä–æ—Å–∏ —á–µ–ª–æ–≤–µ–∫–∞ —Å –∞–º–æCRM –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â–µ —Ä–∞–∑
2. –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏:
   ```bash
   tail -f storage/logs/laravel.log | grep -i "callback debug"
   ```

3. –≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç —á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç AmoCRM

### –°–ø–æ—Å–æ–± 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTPS

```bash
curl -v https://avrb1749.ru/amocrm/callback?code=test&state=test
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –æ state, –Ω–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç route —Ä–∞–±–æ—Ç–∞–µ—Ç
```

### –°–ø–æ—Å–æ–± 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç AmoCRM –Ω–∞–ø—Ä—è–º—É—é

```bash
# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
curl -X POST https://fastis02.amocrm.ru/oauth2/access_token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "client_id=f1457407-e1a5-4694-b976-3bc088294be4&client_secret=AVlSbzrtacTHv62djQC8AubIqVa4bXKiOafaXlEcRfx7YeNAPgRatdJgANeYID38&grant_type=authorization_code&code=AUTHORIZATION_CODE_HERE&redirect_uri=https://avrb1749.ru/amocrm/callback"
```

---

## üö® –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´

### ‚ùå –ü—Ä–∏—á–∏–Ω–∞ 1: Redirect URI –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ AmoCRM

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```
AmoCRM Dashboard ‚Üí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí Redirect URI
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: https://avrb1749.ru/amocrm/callback
–ê –Ω–µ:       https://avrb1749.ru/amocrm/install
–ê –Ω–µ:       http://avrb1749.ru/... (–±–µ–∑ https)
–ê –Ω–µ:       https://avrb1749.ru/ (—Å–ª—ç—à –≤ –∫–æ–Ω—Ü–µ)
```

**–†–µ—à–µ–Ω–∏–µ:**
- –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ AmoCRM Dashboard
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å **—Ç–æ—á–Ω—ã–π URL**

### ‚ùå –ü—Ä–∏—á–∏–Ω–∞ 2: HTTP –≤–º–µ—Å—Ç–æ HTTPS

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```
.env: AMOCRM_REDIRECT_URI=https://avrb1749.ru/amocrm/callback (–ü–†–ê–í–ò–õ–¨–ù–û)
–∏–ª–∏:  AMOCRM_REDIRECT_URI=http://avrb1749.ru/amocrm/callback (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û)
```

**–†–µ—à–µ–Ω–∏–µ:**
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- Update `.env` –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ –∫–æ–Ω—Ñ–∏–≥

### ‚ùå –ü—Ä–∏—á–∏–Ω–∞ 3: Middleware –±–ª–æ–∫–∏—Ä—É–µ—Ç callback

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```
Route group –º–æ–∂–µ—Ç –∏–º–µ—Ç—å middleware –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
–ù–æ callback –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç AmoCRM (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
```

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è `/amocrm/callback`

### ‚ùå –ü—Ä–∏—á–∏–Ω–∞ 4: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –≤ AmoCRM

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```
AmoCRM Dashboard ‚Üí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –°—Ç–∞—Ç—É—Å
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: –ê–∫—Ç–∏–≤–Ω–æ/–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Dashboard

---

## üîê –ü–†–û–í–ï–†–ò–¢–¨ CREDENTIALS

```bash
php artisan tinker

> config('amocrm')

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
- client_id: f1457407-e1a5-4694-b976-3bc088294be4
- client_secret: AVlSbzrtacTHv62djQC8AubIqVa4bXKiOafaXlEcRfx7YeNAPgRatdJgANeYID38
- redirect_uri: https://avrb1749.ru/amocrm/callback
- subdomain: fastis02
```

---

## üìù –û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢

–ü–æ–ª—É—á–∏ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –æ—Ç–ø—Ä–∞–≤—å:

```
1. URL –≥–¥–µ –ø—ã—Ç–∞–µ—à—å—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å: https://avrb1749.ru/amocrm/install
2. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ `.env` (AMOCRM_* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
3. Redirect URI –∏–∑ AmoCRM Dashboard
4. –õ–æ–≥–∏ –∏–∑ storage/logs/laravel.log (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫)
5. –†–µ–∑—É–ª—å—Ç–∞—Ç: curl https://avrb1749.ru/amocrm/callback
6. –†–µ–∑—É–ª—å—Ç–∞—Ç: php artisan amo:status
```

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô PROCESS

–ï—Å–ª–∏ –≤—Å–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞: https://avrb1749.ru/amocrm/install
   ‚îî‚îÄ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è: "AmoCRM OAuth: –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é"
   ‚îî‚îÄ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è: "AmoCRM OAuth: state —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
   ‚îî‚îÄ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞: https://fastis02.amocrm.ru/oauth?...

2. –í AmoCRM:
   ‚îî‚îÄ –í–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å
   ‚îî‚îÄ –ù–∞–∂–∏–º–∞–µ—Ç "–†–∞–∑—Ä–µ—à–∏—Ç—å"

3. AmoCRM –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback:
   ‚îî‚îÄ GET https://avrb1749.ru/amocrm/callback?code=...&state=...&referer=fastis02
   ‚îî‚îÄ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è: "AmoCRM OAuth: callback –ø–æ–ª—É—á–µ–Ω"
   ‚îî‚îÄ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è: "AmoCRM OAuth: –æ–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω"
   ‚îî‚îÄ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è: "AmoCRM —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞"
   ‚îî‚îÄ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞: https://avrb1749.ru (–≥–ª–∞–≤–Ω–∞—è)
   ‚îî‚îÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "amoCRM —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!"

4. –í –ë–î:
   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω —Ç–æ–∫–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ amocrm_tokens
   ‚îî‚îÄ State —É–¥–∞–ª–µ–Ω –∏–∑ —Ç–∞–±–ª–∏—Ü—ã amocrm_oauth_states
```

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:**
   - –ü—Ä–æ–≤–µ—Ä—å Redirect URI –≤ AmoCRM Dashboard
   - –£–±–µ–¥–∏—Å—å —á—Ç–æ HTTPS

2. **–°–µ–π—á–∞—Å:**
   - –ü–æ–≤—Ç–æ—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
   - –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ –¥–ª—è "/amocrm/callback-debug"

3. **–ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   - –ü–æ—à–ª–∏ –ª–æ–≥–∏
   - –ü–æ—à–ª–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç AmoCRM Dashboard
   - –ü–æ—à–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: `curl https://avrb1749.ru/amocrm/callback`

---

**–ì–ª–∞–≤–Ω–∞—è –æ—à–∏–±–∫–∞: Redirect URI –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –º–µ–∂–¥—É AmoCRM –∏ —Ç–≤–æ–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º!**
