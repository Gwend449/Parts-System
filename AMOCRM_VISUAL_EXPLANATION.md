# ğŸ¨ Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ¬ĞĞĞ• ĞĞ‘ĞªĞ¯Ğ¡ĞĞ•ĞĞ˜Ğ• ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ« Ğ˜ Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯

## ğŸ”´ Ğ‘Ğ«Ğ›Ğ (ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ĞŸĞĞ¢ĞĞš Ğ‘Ğ•Ğ— Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ° /amocrm/install
    â”‚
    â”œâ”€ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ state: 74b6eb22a581338909023f94847c9242
    â”œâ”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² SESSION: $_SESSION['amocrm_oauth_state'] = state
    â”œâ”€ session()->save() âœ…
    â”‚
    â””â”€ State Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ’ ĞŸĞĞœĞ¯Ğ¢Ğ˜ âš ï¸

2ï¸âƒ£  ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° AmoCRM
    â”‚
    â””â”€ ĞĞ´Ñ€ĞµÑ: https://fastis02.amocrm.ru/oauth?state=74b6eb...
    
3ï¸âƒ£  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ° AmoCRM Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
    â”‚
    â””â”€ AmoCRM Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ authorization code

4ï¸âƒ£  AmoCRM Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ½Ğ° callback
    â”‚
    â””â”€ URL: https://avrb1749.ru/amocrm/callback?code=...&state=74b6eb...

âŒ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ: Ğ¡ĞµÑÑĞ¸Ñ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ½Ğ°! 
   â””â”€ Ğ”Ñ€ÑƒĞ³Ğ¾Ğ¹ Ğ´Ğ¾Ğ¼ĞµĞ½ (amocrm.ru â†’ avrb1749.ru)
   â””â”€ SESSION cookie Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞµÑ‚ÑÑ
   â””â”€ $_SESSION['amocrm_oauth_state'] == NULL âš ï¸

5ï¸âƒ£  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ state
    â”‚
    â””â”€ $sessionState = session('amocrm_oauth_state') // NULL âŒ
    â””â”€ $requestState = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJ...' // ĞµÑÑ‚ÑŒ âŒ
    â””â”€ if ($sessionState !== $requestState) // ĞĞ¨Ğ˜Ğ‘ĞšĞ! âŒ
       â””â”€ return "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸"

âŒ ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞĞ• Ğ¡Ğ ĞĞ‘ĞĞ¢ĞĞ›Ğ
   â””â”€ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚: "Ğ—Ğ´ĞµÑÑŒ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½ĞµÑ‚"
   â””â”€ Ğ’ Ğ»Ğ¾Ğ³Ğ°Ñ…: "Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ state Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€"
```

## ğŸŸ¢ Ğ¡Ğ¢ĞĞ›Ğ (ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ĞŸĞĞ¢ĞĞš Ğ¡ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•Ğœ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ° /amocrm/install
    â”‚
    â”œâ”€ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ state: 74b6eb22a581338909023f94847c9242
    â”œâ”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ‘Ğ”:
    â”‚  INSERT INTO amocrm_oauth_states
    â”‚  (state, subdomain, created_at, expires_at)
    â”‚  VALUES
    â”‚  ('74b6eb...', 'fastis02', NOW(), NOW() + 15 min)
    â”‚
    â””â”€ State ĞŸĞĞ¡Ğ¢ĞĞ¯ĞĞĞ Ğ’ Ğ‘Ğ” âœ…

2ï¸âƒ£  ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° AmoCRM
    â”‚
    â””â”€ ĞĞ´Ñ€ĞµÑ: https://fastis02.amocrm.ru/oauth?state=74b6eb...

3ï¸âƒ£  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ° AmoCRM Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
    â”‚
    â””â”€ AmoCRM Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ authorization code

4ï¸âƒ£  AmoCRM Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ½Ğ° callback
    â”‚
    â””â”€ URL: https://avrb1749.ru/amocrm/callback?code=...&state=74b6eb...

âœ… STATE Ğ’Ğ¡Ğ• Ğ•Ğ©Ğ• Ğ’ Ğ‘Ğ”!
   â””â”€ Ğ¡ĞµÑÑĞ¸Ñ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑÑ‚ÑŒÑÑ, Ğ½Ğ¾ Ğ‘Ğ” - Ğ²ÑĞµĞ³Ğ´Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° âœ…

5ï¸âƒ£  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ state
    â”‚
    â””â”€ $requestState = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJ...' âœ…
    â””â”€ SELECT * FROM amocrm_oauth_states WHERE state = '74b6eb...'
    â””â”€ if ($record && $record->expires_at > NOW()) // âœ…
       â””â”€ $record->delete() // ÑƒĞ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ state âœ…
       â””â”€ return $record // âœ…

6ï¸âƒ£  ĞĞ±Ğ¼ĞµĞ½Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ´ Ğ½Ğ° Ñ‚Ğ¾ĞºĞµĞ½
    â”‚
    â””â”€ POST https://fastis02.amocrm.ru/oauth2/access_token
    â””â”€ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹: client_id, client_secret, code, redirect_uri
    â””â”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼: access_token, refresh_token, expires_in

7ï¸âƒ£  Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ² Ğ‘Ğ”
    â”‚
    â””â”€ INSERT INTO amocrm_tokens
    â”‚  (domain, access_token, refresh_token, expires_at)
    â”‚  VALUES
    â”‚  ('fastis02', 'eyJ0eXAi...', 'eyJ0eXAi...', NOW() + 30 days)
    â”‚
    â””â”€ return redirect('/')->with('success', 'amoCRM ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ°!')

âœ… ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ!
   â””â”€ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚: "amoCRM ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ°!"
   â””â”€ Ğ’ Ğ‘Ğ” ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½ Ñ‚Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
   â””â”€ Ğ’ Ğ»Ğ¾Ğ³Ğ°Ñ…: "AmoCRM ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ°"
```

## ğŸ“Š Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞÑĞ¿ĞµĞºÑ‚               â”‚ Ğ‘Ğ«Ğ›Ğ (âŒ)            â”‚ Ğ¡Ğ¢ĞĞ›Ğ (âœ…)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ state       â”‚ SESSION (Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ)    â”‚ Ğ‘Ğ” (Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾)          â”‚
â”‚ ĞŸÑ€Ğ¸ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğµ        â”‚ Ğ¢ĞµÑ€ÑĞµÑ‚ÑÑ âŒ          â”‚ ĞÑÑ‚Ğ°ĞµÑ‚ÑÑ âœ…             â”‚
â”‚ HTTPS                â”‚ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹            â”‚ Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾        â”‚
â”‚ TTL (Ğ¶Ğ¸Ğ·Ğ½ÑŒ)          â”‚ Session lifetime    â”‚ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚                â”‚
â”‚ Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ          â”‚ ĞŸĞ»Ğ¾Ñ…Ğ¾Ğµ              â”‚ Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ               â”‚
â”‚ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ…       â”‚ ĞĞµÑ‚ âŒ              â”‚ `amo:cleanup` âœ…        â”‚
â”‚ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ CSRF    â”‚ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾              â”‚ Ğ•Ñ‰Ğµ Ğ»ÑƒÑ‡ÑˆĞµ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Ğ–Ğ˜Ğ—ĞĞ•ĞĞĞ«Ğ™ Ğ¦Ğ˜ĞšĞ› STATE (ĞĞĞ’Ğ«Ğ™)

```
â±ï¸ ĞœĞ˜ĞĞ£Ğ¢Ğ 0
   â”‚
   â”œâ”€ AmocrmOauthState::generateState('fastis02')
   â”‚  â””â”€ state: '74b6eb22a581338909023f94847c9242'
   â”‚  â””â”€ created_at: 2026-01-18 10:51:20
   â”‚  â””â”€ expires_at: 2026-01-18 11:06:20 (Ñ‡ĞµÑ€ĞµĞ· 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
   â”‚
   â””â”€ âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ĞĞšĞ¢Ğ˜Ğ’ĞĞ«Ğ™

â±ï¸ ĞœĞ˜ĞĞ£Ğ¢Ğ 5 (ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ»ÑÑ)
   â”‚
   â”œâ”€ Callback: ?state=74b6eb...
   â”‚  â””â”€ AmocrmOauthState::verifyAndDelete('74b6eb...')
   â”‚  â””â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: expires_at > NOW() ? âœ… YES
   â”‚  â””â”€ DELETE FROM amocrm_oauth_states WHERE state = '74b6eb...'
   â”‚
   â””â”€ âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: Ğ£Ğ”ĞĞ›Ğ•Ğ (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½)

â±ï¸ ĞœĞ˜ĞĞ£Ğ¢Ğ 16+ (State Ğ¸ÑÑ‚ĞµĞº)
   â”‚
   â”œâ”€ Ğ’Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ° ÑĞ¾ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¼ state
   â”‚  â””â”€ AmocrmOauthState::verifyAndDelete('74b6eb...')
   â”‚  â””â”€ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ° (ÑƒĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°) âŒ
   â”‚
   â””â”€ âŒ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ˜

â±ï¸ Ğ•Ğ–Ğ•Ğ”ĞĞ•Ğ’ĞĞ (Maintenance)
   â”‚
   â”œâ”€ php artisan amo:cleanup
   â”‚  â””â”€ DELETE FROM amocrm_oauth_states WHERE expires_at < NOW()
   â”‚  â””â”€ Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ²ÑĞµ state ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ñ‹ Ğ±Ğ¾Ğ»ĞµĞµ Ñ‡ĞµĞ¼ Ğ½Ğ° Ğ´ĞµĞ½ÑŒ
   â”‚
   â””â”€ âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: Ğ‘ĞĞ—Ğ ĞĞ§Ğ˜Ğ©Ğ•ĞĞ
```

## ğŸ—‚ï¸ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ Ğ‘Ğ”

```
Ğ‘Ñ‹Ğ»Ğ¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    SESSION (Ñ„Ğ°Ğ¹Ğ»)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ amocrm_oauth_state âš ï¸   â”‚
â”‚ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸)       â”‚
â”‚ (Ñ‚ĞµÑ€ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ğ¡Ñ‚Ğ°Ğ»Ğ¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DATABASE (MySQL/PostgreSQL)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… amocrm_oauth_states           â”‚
â”‚    â”œâ”€ state (PK)                 â”‚
â”‚    â”œâ”€ subdomain                  â”‚
â”‚    â”œâ”€ created_at                 â”‚
â”‚    â””â”€ expires_at (INDEX)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… amocrm_tokens                 â”‚
â”‚    â”œâ”€ id (PK)                    â”‚
â”‚    â”œâ”€ domain                     â”‚
â”‚    â”œâ”€ access_token               â”‚
â”‚    â”œâ”€ refresh_token              â”‚
â”‚    â”œâ”€ expires_at                 â”‚
â”‚    â”œâ”€ raw (JSON)                 â”‚
â”‚    â””â”€ created_at, updated_at     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… sessions                      â”‚
â”‚    (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ½Ğ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ!)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” ĞŸĞĞ¢ĞĞš Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ state
    â”‚
    â””â”€ bin2hex(random_bytes(32)) = 64 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ° (256 Ğ±Ğ¸Ñ‚) âœ…
       â””â”€ ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑÑ‚Ğ¾Ğ¹ĞºĞ¸Ğ¹
       â””â”€ ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ³Ğ°Ğ´Ğ°Ñ‚ÑŒ

2ï¸âƒ£  Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”
    â”‚
    â””â”€ INSERT Ñ TTL (expires_at) âœ…
    â””â”€ ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ²Ğ°Ğ¶Ğ´Ñ‹ (ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸)

3ï¸âƒ£  ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ² URL
    â”‚
    â””â”€ GET https://amocrm.ru/oauth?state=74b6eb...
    â””â”€ AmoCRM Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ state âœ…

4ï¸âƒ£  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ¸ callback
    â”‚
    â”œâ”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ state Ğ¸Ğ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ° âœ…
    â”œâ”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ»Ğ¸ Ñ‡Ñ‚Ğ¾ exists Ğ² Ğ‘Ğ” âœ…
    â”œâ”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ»Ğ¸ Ñ‡Ñ‚Ğ¾ Ğ½Ğµ Ğ¸ÑÑ‚ĞµĞº âœ…
    â”œâ”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ»Ğ¸ Ñ‡Ñ‚Ğ¾ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ»ÑÑ âœ…
    â”œâ”€ Ğ£Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ğ¸Ğ· Ğ‘Ğ” âœ…
    â”‚
    â””â”€ Ğ•ÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ â†’ ĞĞ¨Ğ˜Ğ‘ĞšĞ âŒ

5ï¸âƒ£  Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    â”‚
    â”œâ”€ Ğ’ÑĞµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ âœ…
    â”œâ”€ IP Ğ°Ğ´Ñ€ĞµÑ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ âœ…
    â”œâ”€ User agent ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ âœ…
    â”œâ”€ ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ âœ…
    â”‚
    â””â”€ ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ
```

## ğŸ’¾ QUERY ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ«

```sql
-- ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ states
SELECT * FROM amocrm_oauth_states 
WHERE expires_at > NOW();

-- ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ states
SELECT * FROM amocrm_oauth_states 
WHERE expires_at < NOW();

-- ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
SELECT 
  domain,
  SUBSTR(access_token, 1, 30) AS token_preview,
  expires_at,
  DATEDIFF(HOUR, NOW(), expires_at) AS hours_left
FROM amocrm_tokens;

-- ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ
DELETE FROM amocrm_oauth_states 
WHERE expires_at < DATE_SUB(NOW(), INTERVAL 1 DAY);
```

---

**Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñ‚Ñ‹ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°ĞµÑˆÑŒ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ Ğ±Ñ‹Ğ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¸ ĞºĞ°Ğº Ğ¾Ğ½Ğ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°! ğŸ‰**
