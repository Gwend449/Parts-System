# üîß –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô

## –ö–æ–≥–¥–∞ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

–¢—ã –≤–∏–¥–∏—à—å –æ–¥–Ω—É –∏–∑ —ç—Ç–∏—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ AmoCRM:
- ‚ùå "–ó–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ—Ç" –ø—Ä–∏ `/amocrm/install`
- ‚ùå "–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
- ‚ùå State –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- ‚ùå –°–µ—Å—Å–∏—è —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –º–∏–≥—Ä–∞—Ü–∏—è
```bash
‚ùå database/migrations/2025_01_15_000000_create_sessions_table.php (–£–î–ê–õ–ï–ù–ê)
```
–ë—ã–ª–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –æ—Å–Ω–æ–≤–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π –≤ `0001_01_01_000000_create_users_table.php`.

### 2. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è OAuth state

**–§–∞–π–ª:** `database/migrations/2026_01_18_000000_create_amocrm_oauth_states_table.php`
```sql
CREATE TABLE amocrm_oauth_states (
    state varchar(255) PRIMARY KEY,
    subdomain varchar(255),
    created_at timestamp,
    expires_at timestamp INDEX
);
```

**–ú–æ–¥–µ–ª—å:** `app/Models/AmocrmOauthState.php`
- `generateState($subdomain)` - —Å–æ–∑–¥–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å state
- `verifyAndDelete($state)` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å state
- `cleanup()` - —É–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ states

### 3. –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª:** `app/Http/Controllers/AmoAuthController.php`

**–î–æ:**
```php
$state = bin2hex(random_bytes(16));
session(['amocrm_oauth_state' => $state]); // ‚ùå —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ
session()->save();
```

**–ü–æ—Å–ª–µ:**
```php
$state = AmocrmOauthState::generateState($subdomain); // ‚úÖ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
// State –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 15 –º–∏–Ω—É—Ç
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ command –¥–ª—è –æ—á–∏—Å—Ç–∫–∏

**–§–∞–π–ª:** `app/Console/Commands/CleanupAmocrm.php`

```bash
php artisan amo:cleanup  # —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ states
```

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
php artisan migrate --force
```

### –®–∞–≥ 2: –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
```bash
php artisan cache:clear
php artisan config:cache
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ:
php artisan serve
# –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ http://localhost:8000/amocrm/install

# –ù–∞ –ø—Ä–æ–¥–µ:
php artisan amo:status
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ | 3 |
| –ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ | 1 |
| –£–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ | 1 |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ | ~200 |
| –í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | 3 –º–∏–Ω—É—Ç—ã ‚è±Ô∏è |

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **CSRF –∑–∞—â–∏—Ç–∞:** State –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ –ë–î, –∞ –Ω–µ –≤ —Å–µ—Å—Å–∏–∏
‚úÖ **TTL:** State –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã —Ç–æ–ª—å–∫–æ 15 –º–∏–Ω—É—Ç
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
‚úÖ **Cleanup:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö states

## üö® –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–∏–¥–∏–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–∏—á–µ–≥–æ!
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ
- –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫ –∂–µ
- –ü—Ä–æ—Å—Ç–æ —Ç–µ–ø–µ—Ä—å —ç—Ç–æ **—Ä–∞–±–æ—Ç–∞–µ—Ç** –ø—Ä–∏ HTTPS –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞—Ö ‚úÖ

**–ó–∞ –∫—É–ª–∏—Å–∞–º–∏:**
```
–ë—ã–ª–æ:
State –≤ —Å–µ—Å—Å–∏–∏ ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ AmoCRM ‚Üí –°–µ—Å—Å–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞ ‚ùå

–°—Ç–∞–ª–æ:
State –≤ –ë–î ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ AmoCRM ‚Üí State –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ –ë–î ‚úÖ
```

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

–ü–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Å–º–æ—Ç—Ä–∏ –≤: `AMOCRM_FIX_COMPLETE.md`

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ: `AMOCRM_FLOW.md`

## ‚ùì –í–æ–ø—Ä–æ—Å—ã?

–°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏:
```bash
tail -f storage/logs/laravel.log | grep -i amocrm
```

–ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å:
```bash
php artisan amo:status
```

–°–º–æ—Ç—Ä–∏ —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å –≤ –ë–î:
```bash
php artisan tinker
\App\Models\AmocrmToken::all()
\App\Models\AmocrmOauthState::all()
```
